---
- name: Install required system packages
  apt:
    name:
      - python3
      - python3-pip
      - git
      - libjpeg-dev
      - build-essential
    update_cache: yes

- name: Ensure application directory exists
  file:
    path: "{{ app_dir }}"
    state: directory
    mode: '0755'

- name: Clone Discord JobBot repository
  git:
    repo: "{{ repo_url }}"
    dest: "{{ app_dir }}"
    version: main
    force: yes

- name: Install Python dependencies
  pip:
    requirements: "{{ app_dir }}/requirements.txt"
    virtualenv: "{{ app_dir }}/venv"
    virtualenv_python: python3

- name: Render .env file from template
  template:
    src: env.j2
    dest: "{{ app_dir }}/.env"
    mode: '0600'

- name: Create start script
  copy:
    dest: "{{ app_dir }}/start.sh"
    mode: '0755'
    content: |
      #!/bin/bash
      cd "{{ app_dir }}"
      source venv/bin/activate
      python3 bot_final_corrected_and_ordered.py

- name: Install systemd service for Discord Bot
  copy:
    dest: /etc/systemd/system/discord-jobbot.service
    mode: '0644'
    content: |
      [Unit]
      Description=Discord JobBot Service
      After=network.target

      [Service]
      Type=simple
      WorkingDirectory={{ app_dir }}
      ExecStart={{ app_dir }}/venv/bin/python3 {{ app_dir }}/bot_final_corrected_and_ordered.py
      EnvironmentFile={{ app_dir }}/.env
      Restart=always
      User=root

      [Install]
      WantedBy=multi-user.target

- name: Reload systemd and enable the bot service
  systemd:
    daemon_reload: yes
    name: discord-jobbot
    enabled: yes
    state: started
