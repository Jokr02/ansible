- name: Ensure required packages
  apt:
    name: "{{ item }}"
    state: present
    update_cache: yes
  loop:
    - git
    - python3-venv

- name: Create code directory if not exists
  file:
    path: "{{ jobbot_code_path }}"
    state: directory

- name: Git checkout into code/
  git:
    repo: "{{ jobbot_repo_url }}"
    dest: "{{ jobbot_code_path }}"
    force: yes
    timeout: 60


- name: Create virtual environment
  shell: python3 -m venv {{ jobbot_path }}/venv
  args:
    creates: "{{ jobbot_path }}/venv"

- name: Install Python requirements
  pip:
    requirements: "{{ jobbot_code_path }}/requirements.txt"
    virtualenv: "{{ jobbot_path }}/venv"

- name: Deploy .env from template
  template:
    src: env.j2
    dest: "{{ jobbot_path }}/.env"
    mode: "0600"

- name: Copy systemd service
  copy:
    src: jobbot.service
    dest: /etc/systemd/system/jobbot.service
    mode: "0644"

- name: Reload and start JobBot service
  systemd:
    name: jobbot.service
    enabled: true
    state: restarted
    daemon_reload: true
